---
title: "Climate Disturbances Overview"
date: "`r Sys.Date()`"
output: 
  officedown::rpptx_document:
    reference_doc: pptx-template.pptx
    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE, 
                      fig.width=12, 
                      fig.height = 6, 
                      dpi=300)

library(here)
library(tidyverse)
library(flextable)
library(extrafont)
library(targets)
library(DiagrammeR)
library(tmap)
library(sf)
library(heatwaveR)
library(bcdata)
library(lubridate)


# ## Flex table defaults
set_flextable_defaults(
  font.family = "Calibri", font.size = 28, font.color = "black",
  text.align = "left",
  table.layout = "fixed",
  theme_fun = "theme_booktabs")

if(.Platform$OS.type == "windows"){
  loadfonts(device = "win", quiet = TRUE)
}

theme_set(theme_minimal(base_family = "Calibri") %+replace%
            theme(plot.caption = element_text(face = "italic", hjust = 1),
                  plot.title.position = "plot",
                  strip.text = element_text(size = 20),
                  panel.grid.major.x = element_blank(),
                  panel.grid.minor.x = element_blank(),
                  axis.title = element_text(size = 18),
                  axis.text = element_text(size = 14))
          )
```


## Overview
```{r, fig.width=2, fig.height=2}
grViz("
digraph rmarkdown {
graph [overlap = true, fontsize = 15]
node [shape = box,
      fontname = Calibri,
      fontcolor = dodgerblue,
      color = Grey]
edge [color = dodgerblue]

'Climate Related Disturbance' -> 'Services Used' -> 'Demographics of that Service Usage'
}
"
)
```


## Overview
```{r, fig.width=2, fig.height=2}
grViz("
digraph rmarkdown {
graph [overlap = true, fontsize = 15]
node [shape = box,
      fontname = Calibri,
      fontcolor = dodgerblue,
      color = Grey]
edge [color = dodgerblue ]

'Climate Related Disturbance' -> 'Services Used' -> 'Demographics of that Service Usage'


node [shape = circle,
      fontname = Calibri,
      fontcolor = MediumPurple,
      color = Grey]

{Space Time}
}
"
)
```


## What is the spatial extent of the MVP?

:::::::::::::: {.columns}
::: {.column}
```{r, fig.width=12, fig.height=12}
tm_shape(tar_read(lha_popn)) +
  tm_polygons(col = "Total", style = "kmeans") +
  tm_layout(title = "Local Health Area Population", scale = 2)
```
:::
::: {.column}
- For MVP do we choose a subset of the province to compare?
- Which spatial data is available?
  - Local Health Area smallest geographic unit of most health data
  - Census Subdivision corresponds to municipal boundaries and is a geography that people intuitively know
:::
::::::::::::::

## Wildfires - Health Authority
```{r, eval=FALSE}
tar_read(area_burned_over_time_by_lha) %>% 
  mutate(FIRE_SIZE_SQKM = FIRE_SIZE_HECTARES/100) %>% 
  ggplot(aes(x = FIRE_YEAR, y = FIRE_SIZE_SQKM, colour = LOCAL_HLTH_AREA_NAME)) +
  geom_line() +
  labs(y = "Area Burned (km^2)") +
  guides(colour = FALSE) +
  theme(axis.title.x = element_blank()) +
  facet_wrap(~HLTH_AUTHORITY_NAME)
```



## Temporal Considerations
```{r, cache=TRUE}
cum_area_burned <- bcdc_query_geodata('22c7cb44-1463-48f7-8e47-88857f207702') %>%
  filter(FIRE_YEAR >= 2014) %>% 
  select(FIRE_YEAR, FIRE_DATE, FIRE_SIZE_HECTARES) %>%
  collect() %>% 
  st_drop_geometry() %>% 
  mutate(year = year(FIRE_DATE)) %>% 
  group_by(year) %>% 
  arrange(FIRE_DATE) %>% 
  mutate(cum_burned = cumsum(FIRE_SIZE_HECTARES))
  
cum_area_burned %>% 
  mutate(day_no_year = as.Date(paste('2010',month(FIRE_DATE), day(FIRE_DATE), sep = "-")), year = factor(year)) %>% 
  ggplot() +
  geom_line(aes(x = day_no_year, y = cum_burned, colour = year)) +
  labs(y = "Cumulative Area Burned (hectares)") +
  theme(axis.title.x = element_blank())
```





## Which Climate Related Disturbance?

### Wildfires

- What is our measure? Air quality?

### Extreme Heat

### Flooding


## Air Quality by Health Service Delivery Area
```{r}
tar_load(pm25_24h)

pm25_24h$daily_avg %>% 
  ggplot(aes(date, y = avg_24h, colour = station_name)) +
  geom_line() +
  guides(colour=FALSE) +
  labs(y = "Daily PM 2.5 value", x = "Date") +
  facet_wrap(~hlth_service_dlvr_area_name) +
  theme(legend.position = "bottom")
```

## Heatwaves

```{r}
tar_load(heatwaves_raw)

heatwaves_raw[["208"]] %>% 
  event_line(min_duration = 2)
```


## River Level

```{r}
tar_load(flood_example)

flood_example %>% 
  filter(Date >= as.Date('2010-01-01')) %>% 
  ggplot(aes(x = Date, y = Value)) +
  geom_line()
  
```



## Wildfires - Provincial

```{r}
tar_read(area_burned_over_time_by_lha) %>% 
  mutate(FIRE_SIZE_SQKM = FIRE_SIZE_HECTARES/100) %>% 
  group_by(FIRE_YEAR) %>% 
  summarise(FIRE_SIZE_SQKM = sum(FIRE_SIZE_SQKM)) %>% 
  ggplot(aes(x = FIRE_YEAR, y = FIRE_SIZE_SQKM)) +
  geom_line() +
  labs(y = "Area Burned (km^2)") +
  theme(axis.title.x = element_blank())
```






## Heatwaves - Health Authority
```{r, eval=FALSE}
tar_read(heatwave_days_over_time_by_lha) %>% 
  mutate(year = as.numeric(year)) %>% 
  filter(year > 1960) %>% 
  ggplot(aes(x = year, y = heatwave_days_per_station)) +
  geom_line(aes(group = LOCAL_HLTH_AREA_NAME), colour = "grey80") +
  geom_smooth() +
  guides(colour = FALSE) +
  facet_wrap(~HLTH_AUTHORITY_NAME)
```

## Service Usage
```{r ft.left=2, ft.top=2}
tribble(
  ~Service, ~Data, ~Difficulty,
  "Ambulance call outs", "NACRS", "Low",
  "Hospital visits", "DAD", "Medium",
  "Income Assistance", "BCEA", "Low",
  "Doctor visits", "MSP Billing", "High"
) %>% 
  flextable() %>% 
  autofit()
```


## Demographics/Economics
- Intersectionality
- GBA+ lens

```{r ft.left=2, ft.top=4}
tribble(
  ~Variables, ~Data, ~`Data Location`,
  "Gender", "Demographics", "DIP",
  "Age", "Demographics/Census", "DIP/Open",
  "Population", "Registry/Census", "DIP/Open",
  "Income", "Census/Cancensus", "Open"
) %>% 
  flextable() %>% 
  autofit()
```

